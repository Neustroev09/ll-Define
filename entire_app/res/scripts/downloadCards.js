var books = 
 {
    1 : {
        "author" : "Л. Кэрролл",
        "title" : "Алиса в стране чудес",
        "img" : "/r/p14.png",
        "description" : "Писатель Льюис Кэрролл написал книгу «Алиса в стране чудес» в 1865 году. Алиса обычная девочка, которая скучая сидела на берегу вместе со своей сестрой, но внезапно странным образом появившийся кролик, показал ей путь в страну чудес со множеством приключений впереди.",
        "difficulty" : "B2",
        "genre" : "Фантастика"
    },
    2 : {
        "author" : "О. Уайлд",
        "title" : "Портрет Дориана Грея",
        "img" : "/r/p15.png",
        "description" : "Писатель Оскар Уайлд написал книгу «Портрет Дориана Грея» в 1890 году. Дориан Грей - красивый молодой человек, который решил посвятить свою жизнь гедонизму и наслаждению, и утопает в разврате. Действия Дориана приводят его к достаточно трегическим последствиям, ведь всему есть своя цена.",
        "difficulty" : "C2",
        "genre" : "Фантастика"
    },
    3 : {
        "author" : "Г. Х. Андерсен",
        "title" : "Русалочка",
        "img" : "/r/p16.png",
        "description" : "Писатель Ганс Христиан Андерсен написал книгу «Русалочка» в 1837 году.  История Русалочки - самой младшей из дочерей короля подводного мира, которая однажды встретила свою настоящую любовь на поверхности моря, и была готова ради нее на все.",
        "difficulty" : "B1",
        "genre" : "Сказка" 
    },
    4 : {
        "author" : "Б. Гримм",
        "title" : "Рапунцель",
        "img" : "/r/p17.png",
        "description" : "Писатели Братья Гримм написали книгу «Рапунцель» в 1812 году. Сказка о паре молодых людей, которая не имела ребенка, но всегда о нем мечтала, и поэтому обратившаяся к колдунье.",
        "difficulty" : "A1",
        "genre" : "Сказка"
    },
    5 : {
        "author" : "В. Гауфф",
        "title" : "История о корабле призраке",
        "img" : "/r/p18.png",
        "description" : "Писатель Вильгельм Гауфф написал книгу «История о корабле призраке» в 1890 году. История молодого человека, отправившегося в путешествия, и нашедшего корабль, вся команда и капитан которого - проклята, и обречена на вечные скитания и муки, в бесконечных морских водах.",
        "difficulty" : "A2",
        "genre" : "Ужасы"
    },
    6 : {
        "author" : "Л. Ф. Баум",
        "title" : "Волшебник страны Оз",
        "img" : "/r/p19.png",
        "description" : "Писатель Франк Баум написал книгу «Волшебник страны Оз» в 1900 году.  Сказка «Волшебник страны Оз» повествует нам историю девочки Дороти, которую унесло ураганом вместе с ее собачкой и домом и она оказалась в стране Оз. Дом упал на злую волшебницу и убил ее, чему былии рады жители страны - жевуны. Девочка обратилась за помощью к доброй волшебнице, чтобы она помогал ей вернуться домой и та направила ее к волшебнику Озу.",
        "difficulty" : "A2",
        "genre" : "Приключения" 
    },
    7 : {
        "author" : "Д. Дефо",
        "title" : "Робинзон Крузо",
        "img" : "/r/p20.png",
        "description" : "Писатель Даниэль Дефо написал книгу «Робинзон Крузо» в 1719 году. Робинзон Крузо всегда мечтал о путешествиях в другие земли, чего он и добился вопреки воли его отца. После кораблекрушения возле неизвестного необитаемого острова, в котором единственным выжившим оказался лишь он, находит силы и собирает всевозможные уцелевшие вещи, чтобы выжить и обосноваться на острове.",
        "difficulty" : "C1",
        "genre" : "Приключения"
    },
    8 : {
        "author" : "Б. Гримм",
        "title" : "Ганзель и Гретель",
        "img" : "/r/p21.png",
        "description" : "Писатели Братья Гримм написали книгу «Ганзель и Гретель» в 1812 году. Гензель и Гретель - брат и сестра, брошенные отцом и мачехой в лесу. Пытаясь выбраться из леса они попадают в руки ведьмы, которая живет в доме из имбирных пряников, торта и пирожных.",
        "difficulty" : "A1",
        "genre" : "Сказка"
    },
    9 : {
        "author" : "Г. Лавкрафт",
        "title" : "Хребты безумия",
        "img" : "/r/p22.png",
        "description" : "Писатель Говард Лавкрафт написал книгу «Хребты безумия» в 1936 году. События книги разворачиваются в далеких снегах Антарктики, где во время одной из экспедиций, ученые обнаруживают останки древнего города, в течение миллионов лет погребенного под огромной толщей льда...",
        "difficulty" : "C1",
        "genre" : "Ужасы" 
    },
    10: {
        "author": "Г. Х. Андерсена",
        "title": "Принцесса на горошине",
        "description": "Ганс Христиан Андерсен написал сказку «Принцесса на горошине» в 1835 году. В сказке говорится о том, как принцесса во время ненастья оказалась в пути, и ей пришлось просить ночлега у королевской семьи. Благородное семейство впустило девушку на ночлег, но она была такой промокшей, а одежда ничуть не походила на одежду принцессы. Королева знала, как проверить настоящая ли царская дочь. В этом королеве помогла маленькая горошинка.",
        "difficulty": "A1",
        "genre": "Сказка",
        "img": "/r/p23.png"
    },
    11: {
        "author": "Б. Гримм",
        "description": "Братья Гримм написали сказку «Бременские музыканты» в 1812 году. История о животных и юноше Трубадуре, которые отправились в город Бремен чтобы стать уличными музыкантами.",
        "difficulty": "A1",
        "genre": "Приключения",
        "img": "/r/p24.png",
        "title": "Бременские музыканты"
    },
    12: {
        "author": "Ш. Перро",
        "description": "«Красная шапочка» - сказка, написанная Ш. Перро в 17 веке. В ней показана история о девочке, которую прозвали Красной Шапочкой. По просьбе матери она отправилась проведать любимую бабушку и несла гостинец для старушки. На пути через лес ей встретился волк.",
        "difficulty": "A1",
        "genre": "Сказка",
        "img": "/r/p25.png",
        "title": "Красная шапочка"
    },
    13: {
        "author": "Б. Гримм",
        "description": "Братья Гримм написали сказку «Белоснежка и семь гномов» в 1812 году. История о прекрасной дочери короля, которую приютили в лесу гномы, спасая от гнева злой мачехи, владеющей волшебным зеркалом. Повествует о зачарованном сне главной героини и её пробуждении благодаря вмешательству королевича.",
        "difficulty": "A1",
        "genre": "Сказка",
        "img": "/r/p26.png",
        "title": "Белоснежка и семь гномов"
    },
    14: {
        "author": "А. Милн",
        "description": "Книга «Винни-Пух» написана английским писателем Аланом Милном в 1926 году. Это добрая весёлая сказка о приключениях плюшевого медвежонка и его верных друзей.",
        "difficulty": "A2",
        "genre": "Приключения",
        "img": "/r/p27.png",
        "title": "Винни-Пух"
        },
    15: {
        "author": "A. де Сент-Экзюпери",
        "description": "Антуан де Сент-Экзюпери написал произведение «Маленький принц» в 1943 году. Волшебная история путешествий маленького принца к далёким планетам, история его удивительных знакомств с капризной, но очаровательной розой, мудрым Лисом, величественным королём и многими другими.",
        "difficulty": "B1",
        "genre": "Сказка",
        "img": "/r/p28.png",
        "title": "Маленький принц"
        },
    16: {
        "author": "Г. Х. Андерсена",
        "description": "Ганс Христиан Андерсен написал сказку «Снежная королева» в 1844 году. Кай и Герда лучшие друзья. Они все делают вместе, пока осколок стекла не ожесточает сердце Кея, и Снежная королева забирает его в свой ледяной дворец. Убитая горем, Герда отправляется на поиски друга.",
        "difficulty": "A2",
        "genre": "Сказка",
        "img": "/r/p29.png",
        "title": "Снежная королева"
        },
    17: {
        "author": "Д. Киз",
        "description": "Элджернон — это мышь, которой в лабораторных условиях повысили уровень интеллекта. Вдохновленные успехом ученые-экспериментаторы решают опробовать свое открытие на людях. Их пациентом становится умственно отсталый Шарль. Эксперимент удается, и Шарль начинает жить нормальной жизнью. Однако вскоре он оказывается перед сложным выбором — оставаться «подопытным кроликом» или вновь стать самим собой.",
        "difficulty": "B1",
        "genre": "Фантастика",
        "img": "/r/p30.png",
        "title": "Цветы для Элджернона"
        },
    18: {
        "author": "Дж. К. Роулинг",
        "description": "Гарри Поттер, одиннадцатилетний сирота, обнаруживает, что он волшебник, и его приглашают учиться в Хогвартс. Даже когда он убегает от унылой жизни и попадает в мир магии, его ждут неприятности.",
        "difficulty": "B2",
        "genre": "Фэнтези",
        "img": "/r/p31.png",
        "title": "Гарри Поттер и философский камень"
        },
    19: {
        "author": "Л. М. Олкотт",
        "description": "В «Маленьких женщинах» рассказана история четырех дружных, непохожих друг на друга сестер: романтичной Мег, взбалмошной Джо, тихони Бет и своенравной Эми. Вместе с матерью дожидаясь возвращения отца с войны, девочки проходят непростой путь взросления, на котором им встречаются лишения и награды, смертельные опасности и бескорыстная помощь, ложные ориентиры и настоящие друзья.",
        "difficulty": "B2",
        "genre": "Роман",
        "img": "/r/p32.png",
        "title": "Маленькие женщины"
        },
    20: {
        "author": "Х. Ли",
        "description": "История судебного процесса по делу чернокожего парня, обвиненного в насилии над белой девушкой. Но прежде всего - история переломной эпохи, когда ксенофобия, расизм, нетерпимость и ханжество, присущие американскому югу, постепенно уходят в прошлое.",
        "difficulty": "C1",
        "genre": "Драма",
        "img": "/r/p33.png",
        "title": "Убить пересмешника"
        },
    21: {"author": "О. Хаксли",
            "description": "«О дивный новый мир» - изысканная и остроумная антиутопия о генетически программируемом «обществе потребления», в котором разворачивается трагическая история Дикаря - «Гамлета» этого мира.",
            "difficulty": "C1",
            "genre": "Фантастика",
            "img": "/r/p34.png",
            "title": "О дивный новый мир"
        }
};

var maxCountBooksInPage = 8;
var currentPage = 1;
var booksId = new Array();
var filterBlock = document.querySelector(".filterBlock");
var cloneBlock = filterBlock.cloneNode(true);
var filterActive = false;

function openPage(numberPage=1) {
    currentPage = numberPage;
    currBtnPage(numberPage)
    clearCard();
    downloadCard(numberPage);
}

function currBtnPage(numberPage) {
    let pageBtn = "page" + numberPage;
    document.getElementById("page1").className = "page-item";
    document.getElementById("page2").className = "page-item";
    document.getElementById("page3").className = "page-item";
    document.getElementById(pageBtn).className = "page-item active";
}

function prevBtn() {
    let prev = document.getElementById("page" + (currentPage-1)).style.display;
    if (currentPage - 1 > 0 && prev == "") {
        openPage(currentPage-1);
    }
}

function nextBtn() {
    let next = document.getElementById("page" + (currentPage+1)).style.display;
    if (currentPage + 1 < 4 && next == "") {
        openPage(currentPage+1);
    }
}

function downloadCard(numberPage=1) {
    updateBtnPage();
    currBtnPage(numberPage)
    if (filterActive) {
        for (let i = (numberPage-1)*maxCountBooksInPage; i < (numberPage)*maxCountBooksInPage; ++i) {
            let key = booksId[i]; 
            if (books[key] === undefined)
                break;             
            createCard(key);
        }
    } else {
        for (let i = 1; i <= maxCountBooksInPage; ++i) {
            let key = i+(numberPage-1)*maxCountBooksInPage;
            if (books[key] === undefined)
                break; 
            createCard(key);
        }
    }

    if (document.documentElement.scrollWidth < 1000) {
        document.querySelector(".filterBlock").style.display = "none";
        document.querySelector(".btnOffCanvas").style.display = "";
    } else {
        document.querySelector(".filterBlock").style.display = "";
        document.querySelector(".btnOffCanvas").style.display = "none";
    }
}

function updateBtnPage() {
    document.getElementById("pagePrev").style.display = "";
    document.getElementById("page1").style.display = ""; 
    document.getElementById("page2").style.display = ""; 
    document.getElementById("page3").style.display = ""; 
    document.getElementById("pageNext").style.display = ""; 
    if (booksId.length <= maxCountBooksInPage && filterActive) {
        document.getElementById("pagePrev").style.display = "none";
        document.getElementById("page1").style.display = "none"; 
        document.getElementById("page2").style.display = "none"; 
        document.getElementById("page3").style.display = "none"; 
        document.getElementById("pageNext").style.display = "none"; 
    }  
    if (booksId.length > maxCountBooksInPage && booksId.length <= maxCountBooksInPage*2) {
        document.getElementById("page3").style.display = "none"; 
    }  
}

function updateCard(booksId) {
    if (!booksId.length) {
        currBtnPage(1);
        updateBtnPage();
        clearCard();
        var cardsTable = document.querySelector("#cardsTable");
        var label = document.createElement("div");
        label.className = "filterTitle";
        label.innerHTML = "Ничего не найдено"
        label.style = "margin-top: 25%; margin-bottom: 25%; text-align: center;";
        cardsTable.appendChild(label);
    } else {
        currBtnPage(1);
        clearCard();
        updateBtnPage();
        for (let i = 0; i < booksId.length; ++i) {
            if (i >= maxCountBooksInPage || books[booksId[i]] === undefined) {
                break;
            }
            createCard(booksId[i]);
        }
    }
}

function clearCard() {
    document.querySelector("#cardsTable").innerHTML = "";
}

function createCard(id) {
    var col = document.createElement("col");

    var card = document.createElement("div");
    card.className = "card";
    card.dataset.bsWhatever = `${id}`;
    card.dataset.bsToggle = "modal";
    card.dataset.bsTarget = "#exampleModal";
    col.appendChild(card);

    var author = document.createElement("span");
    author.className = "authorCard";
    author.innerHTML = books[id]["author"];
    card.appendChild(author);

    var cardBody = document.createElement("div");
    cardBody.className = "card cardImgDiv";
    card.appendChild(cardBody);

    var img = document.createElement("img");
    img.className = "card-img-top cardImg";
    img.src = books[id]["img"];
    cardBody.appendChild(img);

    var title = document.createElement("span");
    title.className = "titleCard";
    title.innerHTML = books[id]["title"];
    card.appendChild(title);

    var cardsTable = document.querySelector("#cardsTable");
    cardsTable.appendChild(col);
}

function descriptionCard(event) {
    var bookId = event.relatedTarget.getAttribute("data-bs-whatever");
    var modalTitle = exampleModal.querySelector("#modalLabel");
    modalTitle.innerHTML = `Книга «${books[bookId]["title"]}» на английском языке`;

    var modalBody = exampleModal.querySelector("#modalBody");
    modalBody.innerHTML = `${books[bookId]["description"]}`;

    var modalBody = exampleModal.querySelector("#modalFooterDifficulty");
    modalBody.innerHTML = `Сложность: <b>${books[bookId]["difficulty"]}</b>`;

    var modalBody = exampleModal.querySelector("#modalFooterGenre");
    modalBody.innerHTML = `Жанр: <b>${books[bookId]["genre"]}</b>`;
}

var exampleModal = document.getElementById("exampleModal")
exampleModal.addEventListener("show.bs.modal", function (event) {
    descriptionCard(event);
})


function filter() {
    var emptyPage = false;
    booksId.splice(0, booksId.length);

    var nameInput = document.querySelector(".inputText").value; 
    if (nameInput != "") {
        filterByTitleAuthor(booksId, nameInput)
        emptyPage = true
    }

    var checkObjList = document.querySelectorAll("#genreCheck");
    let checkGenre = Array();
    for (let i = 0; i < checkObjList.length; ++i) {
        if (checkObjList[i].checked) {
            checkGenre.push.apply(checkGenre, filterCheck(checkObjList[i].value, "genre"));
            emptyPage = true
        }
    }

    // TODO: вынести в отдельную функцию
    let intersection;
    if (booksId.length != 0  && checkGenre.length != 0) {
        intersection = booksId.filter(x => checkGenre.includes(x));
        booksId.splice(0, booksId.length);
        booksId.push.apply(booksId, intersection);
    } else {
        booksId.push.apply(booksId, checkGenre);
    }

    var checkObjList = document.querySelectorAll("#difficultyCheck");
    let checkDifficulty = Array();
    for (let i = 0; i < checkObjList.length; ++i) {
        if (checkObjList[i].checked) {
            checkDifficulty.push.apply(checkDifficulty, filterCheck(checkObjList[i].value, "difficulty"));
            emptyPage = true
        }
    }

    // TODO: вынести в отдельную функцию
    if (booksId.length != 0 && checkDifficulty.length != 0) {
        intersection = booksId.filter(x => checkDifficulty.includes(x));
        booksId.splice(0, booksId.length);
        booksId.push.apply(booksId, intersection);
    } else {
        booksId.push.apply(booksId, checkDifficulty);
    }

    if (!emptyPage) {
        filterActive = false;
        clearCard()
        currentPage = 1;
        downloadCard(currentPage);
    } else {
        filterActive = true;
        updateCard(booksId);
    }
   
    document.getElementById("btnCloseOff").click();
}

function filterByTitleAuthor(booksId, nameInput) {
    nameInput = nameInput.toLowerCase()
    for (const [key, value] of Object.entries(books)) {
        if (value["author"].toLowerCase().indexOf(nameInput,0) != -1 || value["title"].toLowerCase().indexOf(nameInput,0) != -1) {
            booksId.push(key);
        }
    }
}

function filterCheck(checkValue, checkKey) {
    let booksIdCheck = new Array();
    for (const [key, value] of Object.entries(books)) {
        if (value[checkKey] == checkValue) {
            booksIdCheck.push(key);
        }
    }
    return booksIdCheck;
}

function openOffCanvas() {
    var offCanvasBody = document.querySelector(".offcanvas-body");
    offCanvasBody.innerHTML = "";
    cloneBlock.style.display = "";
    cloneBlock.className = "filterBlockOff";
    offCanvasBody.appendChild(cloneBlock);    
}

window.addEventListener("resize", function(event) {
    if (document.documentElement.scrollWidth < 1000) {
        document.querySelector(".filterBlock").style.display = "none";
        document.querySelector(".btnOffCanvas").style.display = "";
    } else {
        document.querySelector(".filterBlock").style.display = "";
        document.querySelector(".btnOffCanvas").style.display = "none";
    }
}, true);

function isNumber(n) { 
    return /^-?[\d.]+(?:e-?\d+)?$/.test(n); 
} 