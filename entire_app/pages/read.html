<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Загрузить книгу</title>
    <link rel="icon" href="../r/p1.png" type="image/icon type">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="../r/s1.css" />
	<link rel="stylesheet" href="../r/s2.css" />
	<style>
		@font-face {
			font-family: Montserrat-Bold; 
			src: url(../r/f1.ttf);
		}

		@font-face {
			font-family: Montserrat-Medium; 
			src: url(../r/f2.ttf);
		}
	</style>
</head>

<body class="bodyStyle">
    <nav class="navbar navbar-expand-lg navbar-light bg-white headerToolbar">
        <div class="container-fluid">            
            <p class="navbar-brand logoName offset-1"><img src="../r/p1.png" class="logoImg">II Define</p>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarToggler" 
                                aria-controls="navbarToggler" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse list" id="navbarToggler">
                <ul class="navbar-nav w-100 align-items-center justify-content-evenly">
                    <li class="nav-item">
                        <a class="nav-link liText" href="/">О нас</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link liText" href="/selection">Подборка книг</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link liText" href="/download" style="font-family: Montserrat-Bold;
                        font-size: 16px;
                        font-weight: bold;
                        color: #000;
                        border-bottom: 4px solid #b0dddc">
                        Загрузить книгу</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link liText" href="/test">Пройти тест</a>
                    </li>
                </ul>

                <form class="signinButton d-flex">
                    <button class="btn signinButton">Login</button>
                </form>
            </div>
        </div>
    </nav>
	
	
	<div id="view_panel">
	</div>
	<div id="viewer"></div>
	
	<style>
		html {
			overflow-y:scroll;
		}
	
		.page_con{
			text-align: justify;
			font-size: 20px;
			padding: 20px;
			
		}
		
		.but_pan {
			text-align: center;
			margin-top: 10px;
			width: 100%;
			margin-bottom: 50px;
		}
		
		.cng_page {
			margin: 5px 2%;
			padding: 10px 5px;
			width: 46%;
			display:inline-block;
			border: 2px solid #555;
			color: #555;
			font-weight: bold;
			border-radius: 5px;
			cursor:pointer;
		}
		
		.rn_sldr {
			width: 80%;
			margin-left: 5%;
		}
		
		.page_num {
			width: 5%;
			margin-left: 2%;
			outline: none;
			text-align: right;
		}
		
		.book_len {
			
		}
		
	</style>
	
	<script>
		var first_book_page = 0, last_book_page = #BOOK_LAST_PAGE_NUMBER#
		
		var page_viewer = document.querySelector("#viewer"),
			view_panel = document.querySelector("#view_panel");
		
		range_slider = document.createElement('input');
		range_slider.className = 'rn_sldr';
		
		range_slider.setAttribute('type', 'range');
		range_slider.setAttribute('min', 1);
		range_slider.setAttribute('max', last_book_page + 1);
		range_slider.value = 1;
		
		page_number = document.createElement('input')
		page_number.className = 'page_num';
		page_number.value = 1;
		
		page_number.setAttribute('type', 'text');
		
		book_len = document.createElement('span');
		book_len.className = 'book_len';
		book_len.innerHTML = ' из ' + (last_book_page + 1);
				
		var current_page = 0;
		
		function update_page_number() {
			page_number.value = current_page + 1
		}
		
		function update_range_slider () {
			range_slider.value = current_page + 1
		}
		
		function render_viewer() {
		
			page_viewer.innerHTML = '';
			
			var page_container = document.createElement('div');
			page_container.className = 'page_con'
			
			var xhr = new XMLHttpRequest();
			function book_page_load() {
				var cur_url = window.location.href.split('?');
				var t_param = cur_url[cur_url.length - 1];
				xhr.open('GET', '/pc?' + t_param + '&pn=' + current_page);
				xhr.send();
				xhr.onload = function render_page() {
					if (xhr.status != 200) {
						page_container.textContent = '404'
					} else { 
						json_page = JSON.parse(xhr.response);
						console.log(json_page);
						flat_html_page = '';
						is_in_parag = false;
						for (var key in json_page) {
							if (json_page.hasOwnProperty(key)) {
								if (json_page[key].substring(0, 2) == "\n\n") {
									if (is_in_parag) {
										flat_html_page += '</p><p>';
									} else {
										is_in_parag = true;
										flat_html_page += '<p>';
									}
								}
								flat_html_page += '<span name="s' + key + '">' + json_page[key].trim().replace('\n\n', '<br>') + '.</span>';
							}
						}
						if (is_in_parag) {
							flat_html_page += '</p>';
						}
						page_container.innerHTML = flat_html_page;
						
						page_viewer.appendChild(page_container);
						
						function next_page(){
							if (current_page < last_book_page) {
								current_page += 1;
								update_range_slider();
								update_page_number();
								render_viewer();
							}
						}
						
						function previous_page(){
							if (current_page > 0) {
								current_page -= 1;
								update_range_slider();
								update_page_number();
								render_viewer();
							}
						}
						
						var buttons_panel = document.createElement('div');
						buttons_panel.className = 'but_pan';
						
						if (current_page > 0) {
							var prev_page_but = document.createElement('span');
							prev_page_but.className = 'cng_page';
							prev_page_but.innerHTML = '< Сюда';
							prev_page_but.addEventListener('click', previous_page);
							buttons_panel.appendChild(prev_page_but);
						}
						
						if (current_page < last_book_page) {
							var next_page_but = document.createElement('span');
							next_page_but.className = 'cng_page';
							next_page_but.innerHTML = 'Туда >';
							next_page_but.addEventListener('click', next_page);
							buttons_panel.appendChild(next_page_but);
						}
						
						page_viewer.appendChild(buttons_panel);
						
					}
				};
			}
			book_page_load();	
		}
		
		render_viewer();
		
		range_slider.addEventListener("input", () => {
			range_slider.setAttribute('title', range_slider.value);
			current_page = range_slider.value - 1;
			update_page_number();
			render_viewer();
		});
		
		page_number.addEventListener("keydown", (e) => {
			if (e.key == "Enter") {
				if (page_number.value < 1) {
					page_number.value = 1;
				} else if (page_number.value > last_book_page) {
					page_number.value = last_book_page + 1;
				}
				current_page = page_number.value - 1;
				update_range_slider();
				render_viewer();
			}
		});
		
		view_panel.appendChild(range_slider);
		view_panel.appendChild(page_number);
		view_panel.appendChild(book_len);
		
		
	</script>
	
	
</body>
</html>